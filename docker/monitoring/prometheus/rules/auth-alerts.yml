# ë‹´ë‹¹: ì¸ì¦/ì¸ê°€ ë„ë©”ì¸

groups:
  # ==================== Auth ë„ë©”ì¸ ì•Œë¦¼ ====================
  - name: auth_alerts
    interval: 30s
    rules:
      # ğŸš¨ CRITICAL: ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸‰ì¦ (Brute Force ì˜ì‹¬)
      - alert: LoginFailureSpike
        expr: |
          sum(rate(auth_login_total{result="failure"}[5m])) > 10
        for: 2m
        labels:
          severity: critical
          domain: auth
        annotations:
          summary: "ë¡œê·¸ì¸ ì‹¤íŒ¨ ê¸‰ì¦ íƒì§€"
          description: "5ë¶„ê°„ ë¡œê·¸ì¸ ì‹¤íŒ¨ê°€ ë¶„ë‹¹ 10íšŒ ì´ìƒì…ë‹ˆë‹¤. Brute Force ê³µê²© ê°€ëŠ¥ì„±."
          current_value: "{{ $value | printf \"%.2f\" }} failures/min"
          threshold: "10 failures/min"

      # ğŸš¨ CRITICAL: ê³„ì • ì ê¸ˆ ë‹¤ìˆ˜ ë°œìƒ
      - alert: HighAccountLockRate
        expr: |
          sum(increase(auth_account_locked_total[10m])) > 5
        for: 1m
        labels:
          severity: critical
          domain: auth
        annotations:
          summary: "ê³„ì • ì ê¸ˆ ë‹¤ìˆ˜ ë°œìƒ"
          description: "10ë¶„ê°„ {{ $value }}ê°œ ê³„ì •ì´ ì ê²¼ìŠµë‹ˆë‹¤. ê³µê²© ë˜ëŠ” ì‹œìŠ¤í…œ ì´ìƒ í™•ì¸ í•„ìš”."
          current_value: "{{ $value }} locks"
          threshold: "5 locks/10min"

      # âš ï¸ WARNING: ë¡œê·¸ì¸ ì„±ê³µë¥  ì €í•˜
      - alert: LowLoginSuccessRate
        expr: |
          (
            sum(rate(auth_login_total{result="success"}[15m])) 
            / sum(rate(auth_login_total[15m]))
          ) * 100 < 80
        for: 5m
        labels:
          severity: warning
          domain: auth
        annotations:
          summary: "ë¡œê·¸ì¸ ì„±ê³µë¥  ì €í•˜"
          description: "15ë¶„ê°„ ë¡œê·¸ì¸ ì„±ê³µë¥ ì´ {{ $value | printf \"%.1f\" }}%ë¡œ 80% ë¯¸ë§Œì…ë‹ˆë‹¤."
          current_value: "{{ $value | printf \"%.1f\" }}%"
          threshold: "80%"

      # âš ï¸ WARNING: Rate Limit ê³¼ë‹¤ íŠ¸ë¦¬ê±°
      - alert: RateLimitTriggered
        expr: |
          sum(increase(security_rate_limit_triggered_total[10m])) by (endpoint) > 20
        for: 2m
        labels:
          severity: warning
          domain: auth
        annotations:
          summary: "Rate Limit ê³¼ë‹¤ íŠ¸ë¦¬ê±°"
          description: "ì—”ë“œí¬ì¸íŠ¸ {{ $labels.endpoint }}ì—ì„œ 10ë¶„ê°„ {{ $value }}íšŒ Rate Limit ë°œë™."
          current_value: "{{ $value }} triggers"
          threshold: "20 triggers/10min"

  # ==================== Email ë„ë©”ì¸ ì•Œë¦¼ ====================
  - name: email_alerts
    interval: 30s
    rules:
      # âš ï¸ WARNING: ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ìœ¨ ì¦ê°€
      - alert: HighEmailFailureRate
        expr: |
          (
            sum(rate(email_sent_total{result="failure"}[10m])) 
            / sum(rate(email_sent_total[10m]))
          ) * 100 > 10
        for: 5m
        labels:
          severity: warning
          domain: email
        annotations:
          summary: "ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ìœ¨ ì¦ê°€"
          description: "10ë¶„ê°„ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ìœ¨ì´ {{ $value | printf \"%.1f\" }}%ì…ë‹ˆë‹¤."
          threshold: "10%"

      # âš ï¸ WARNING: ì´ë©”ì¼ ì¸ì¦ ì‹¤íŒ¨ ê¸‰ì¦
      - alert: HighVerificationFailureRate
        expr: |
          (
            sum(rate(email_verification_total{result="failure"}[10m])) 
            / sum(rate(email_verification_total[10m]))
          ) * 100 > 30
        for: 5m
        labels:
          severity: warning
          domain: email
        annotations:
          summary: "ì´ë©”ì¼ ì¸ì¦ ì‹¤íŒ¨ ê¸‰ì¦"
          description: "10ë¶„ê°„ ì´ë©”ì¼ ì¸ì¦ ì‹¤íŒ¨ìœ¨ì´ {{ $value | printf \"%.1f\" }}%ì…ë‹ˆë‹¤."
          threshold: "30%"

  # ==================== Member ë„ë©”ì¸ ì•Œë¦¼ ====================
  - name: member_alerts
    interval: 30s
    rules:
      # âš ï¸ WARNING: íšŒì› íƒˆí‡´ ê¸‰ì¦
      - alert: HighWithdrawRate
        expr: |
          sum(increase(member_withdraw_total[1h])) > 10
        for: 5m
        labels:
          severity: warning
          domain: member
        annotations:
          summary: "íšŒì› íƒˆí‡´ ê¸‰ì¦"
          description: "1ì‹œê°„ ë™ì•ˆ {{ $value }}ëª…ì´ íƒˆí‡´í–ˆìŠµë‹ˆë‹¤. ì„œë¹„ìŠ¤ ì´ìŠˆ í™•ì¸ í•„ìš”."
          current_value: "{{ $value }} withdrawals"
          threshold: "10 withdrawals/hour"

  # ==================== ë³´ì•ˆ ìœ„í˜‘ ì•Œë¦¼ ====================
  - name: security_alerts
    interval: 15s
    rules:
      # ğŸš¨ CRITICAL: ë³´ì•ˆ ìœ„í˜‘ íƒì§€
      - alert: SecurityThreatDetected
        expr: |
          sum(increase(security_threat_detected_total{severity="HIGH"}[5m])) > 0
        for: 0m
        labels:
          severity: critical
          domain: security
        annotations:
          summary: "ê³ ìœ„í—˜ ë³´ì•ˆ ìœ„í˜‘ íƒì§€"
          description: "ì‹¬ê°ë„ HIGHì˜ ë³´ì•ˆ ìœ„í˜‘ì´ íƒì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ í•„ìš”."

  # ==================== ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ====================
  - name: service_health
    interval: 30s
    rules:
      # ğŸš¨ CRITICAL: ì„œë¹„ìŠ¤ ë‹¤ìš´
      - alert: ServiceDown
        expr: up{job="tt-app"} == 0
        for: 1m
        labels:
          severity: critical
          domain: infra
        annotations:
          summary: "TT ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ë‹¤ìš´"
          description: "Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

      # âš ï¸ WARNING: API ì‘ë‹µ ì§€ì—°
      - alert: HighApiLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_server_requests_seconds_bucket{uri=~"/api/auth.*"}[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
          domain: auth
        annotations:
          summary: "Auth API ì‘ë‹µ ì§€ì—°"
          description: "Auth APIì˜ P95 ì‘ë‹µì‹œê°„ì´ {{ $value | printf \"%.2f\" }}ì´ˆë¡œ 2ì´ˆë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤."
