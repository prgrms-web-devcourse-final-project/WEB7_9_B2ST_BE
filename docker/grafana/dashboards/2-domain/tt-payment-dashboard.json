# ----- 결제 현황 (PaymentMetrics 기반) -----

# 결제 성공 추이
sum(rate(payment_total{result="success"
}[
    1m
]))

# 결제 실패 추이
sum(rate(payment_total{result="failure"
}[
    1m
]))

# 결제 성공률
sum(rate(payment_total{result="success"
}[
    5m
])) / sum(rate(payment_total[
    5m
])) * 100

# 도메인 타입별 결제 성공
sum(rate(payment_total{result="success"
}[
    5m
])) by (domain_type)

# 결제 수단별 분포
sum(rate(payment_total{result="success"
}[
    5m
])) by (method)

# 결제 실패 사유별 분포
sum(rate(payment_total{result="failure"
}[
    5m
])) by (reason)

# 환불 추이
sum(rate(payment_refund_total[
    1m
]))

# 환불 금액 누적
sum(increase(payment_refund_amount_total[
    24h
])) by (domain_type)

# 결제 금액 분포 P50
payment_amount{quantile="0.5"
}

# 결제 금액 분포 P95
payment_amount{quantile="0.95"
}

# 결제 처리 시간 P95
histogram_quantile(0.95, sum(rate(payment_process_duration_seconds_bucket[
    5m
])) by (le))

# 결제 처리 시간 P99
histogram_quantile(0.99, sum(rate(payment_process_duration_seconds_bucket[
    5m
])) by (le))


# ----- Payment API 성능 -----

# Payment API P95 응답시간
histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{uri=~"/api/payments.*"
}[
    5m
])) by (le))

# Payment API P99 응답시간
histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{uri=~"/api/payments.*"
}[
    5m
])) by (le))

# Payment API 에러율
sum(rate(http_server_requests_seconds_count{uri=~"/api/payments.*", status=~"5.."
}[
    5m
])) / sum(rate(http_server_requests_seconds_count{uri=~"/api/payments.*"
}[
    5m
])) * 100

# Payment API RPS
sum(rate(http_server_requests_seconds_count{uri=~"/api/payments.*"
}[
    1m
]))
